import { useEffect, useLayoutEffect, useRef, useState } from "react";
import "./Preloader.css";

interface PreloaderProps {
  onComplete?: () => void;
}

const parseDurationMs = (value: string, fallback: number) => {
  const trimmed = value.trim();
  if (!trimmed) return fallback;
  if (trimmed.endsWith("ms")) {
    const parsed = Number.parseFloat(trimmed);
    return Number.isFinite(parsed) ? parsed : fallback;
  }
  if (trimmed.endsWith("s")) {
    const parsed = Number.parseFloat(trimmed);
    return Number.isFinite(parsed) ? parsed * 1000 : fallback;
  }
  const parsed = Number.parseFloat(trimmed);
  return Number.isFinite(parsed) ? parsed : fallback;
};

export default function Preloader({ onComplete }: PreloaderProps) {
  const preloaderRef = useRef<HTMLDivElement>(null);
  const strokeRef = useRef<SVGPathElement>(null);
  const onCompleteRef = useRef(onComplete);
  const [hidden, setHidden] = useState(false);
  const [isExiting, setIsExiting] = useState(false);

  // Keep ref in sync without causing effect re-runs
  useEffect(() => {
    onCompleteRef.current = onComplete;
  });

  useLayoutEffect(() => {
    const container = preloaderRef.current;
    const stroke = strokeRef.current;
    if (!container || !stroke) return;
    const length = Math.ceil(stroke.getTotalLength());
    container.style.setProperty("--path-length", `${length}`);
  }, []);

  // Lock scroll while preloader is visible
  useEffect(() => {
    document.documentElement.classList.add("scroll-locked");
    return () => {
      document.documentElement.classList.remove("scroll-locked");
    };
  }, []);

  useEffect(() => {
    const el = preloaderRef.current;
    if (!el) return;

    const styles = getComputedStyle(el);
    const hideDelay = parseDurationMs(
      styles.getPropertyValue("--loader-hide-delay"),
      5000
    );
    const fadeDuration = parseDurationMs(
      styles.getPropertyValue("--loader-fade-duration"),
      1000
    );
    const exitDuration = parseDurationMs(
      styles.getPropertyValue("--loader-exit-duration"),
      fadeDuration
    );

    let hideTimer: ReturnType<typeof setTimeout>;
    let removeTimer: ReturnType<typeof setTimeout>;

    hideTimer = setTimeout(() => {
      onCompleteRef.current?.();
      setIsExiting(true);

      removeTimer = setTimeout(() => {
        document.documentElement.classList.remove("scroll-locked");
        setHidden(true);
      }, exitDuration);
    }, hideDelay);

    return () => {
      clearTimeout(hideTimer);
      clearTimeout(removeTimer);
    };
  }, []);

  if (hidden) return null;

  return (
    <div
      className={`preloader${isExiting ? " is-exiting" : ""}${
        hidden ? " hidden" : ""
      }`}
      ref={preloaderRef}
      aria-hidden="true"
    >
      <div className="logo-container" aria-hidden="true">
        <svg
          className="logo-svg"
          xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 349 243"
        >
          <path
            className="logo-glow"
            d="M 176.00 10.00 L 161.00 25.00 L 160.00 25.00 L 160.00 26.00 L 159.00 27.00 L 158.00 27.00 L 61.00 124.00 L 60.00 124.00 L 16.00 168.00 L 16.00 169.00 L 14.00 171.00 L 14.00 172.00 L 13.00 173.00 L 13.00 174.00 L 12.00 175.00 L 12.00 176.00 L 11.00 177.00 L 11.00 180.00 L 10.00 181.00 L 10.00 191.00 L 11.00 192.00 L 11.00 196.00 L 12.00 197.00 L 12.00 199.00 L 13.00 200.00 L 13.00 201.00 L 14.00 202.00 L 14.00 204.00 L 16.00 206.00 L 16.00 207.00 L 17.00 208.00 L 17.00 209.00 L 19.00 211.00 L 19.00 212.00 L 30.00 223.00 L 31.00 223.00 L 33.00 225.00 L 34.00 225.00 L 36.00 227.00 L 37.00 227.00 L 38.00 228.00 L 39.00 228.00 L 40.00 229.00 L 42.00 229.00 L 43.00 230.00 L 45.00 230.00 L 46.00 231.00 L 50.00 231.00 L 51.00 232.00 L 59.00 232.00 L 60.00 231.00 L 64.00 231.00 L 65.00 230.00 L 67.00 230.00 L 68.00 229.00 L 69.00 229.00 L 70.00 228.00 L 71.00 228.00 L 73.00 226.00 L 74.00 226.00 L 78.00 222.00 L 79.00 222.00 L 81.00 220.00 L 81.00 219.00 L 121.00 179.00 L 121.00 178.00 L 161.00 138.00 L 161.00 137.00 L 177.00 121.00 L 187.00 131.00 L 187.00 132.00 L 201.00 146.00 L 201.00 147.00 L 214.00 160.00 L 214.00 161.00 L 227.00 174.00 L 227.00 175.00 L 240.00 188.00 L 240.00 189.00 L 254.00 203.00 L 254.00 204.00 L 267.00 217.00 L 267.00 218.00 L 277.00 228.00 L 278.00 228.00 L 280.00 230.00 L 281.00 230.00 L 282.00 231.00 L 284.00 231.00 L 285.00 232.00 L 288.00 232.00 L 289.00 233.00 L 297.00 233.00 L 298.00 232.00 L 302.00 232.00 L 303.00 231.00 L 305.00 231.00 L 306.00 230.00 L 308.00 230.00 L 309.00 229.00 L 310.00 229.00 L 311.00 228.00 L 312.00 228.00 L 314.00 226.00 L 315.00 226.00 L 317.00 224.00 L 318.00 224.00 L 322.00 220.00 L 323.00 220.00 L 326.00 217.00 L 326.00 216.00 L 330.00 212.00 L 330.00 211.00 L 332.00 209.00 L 332.00 208.00 L 334.00 206.00 L 334.00 205.00 L 335.00 204.00 L 335.00 203.00 L 336.00 202.00 L 336.00 200.00 L 337.00 199.00 L 337.00 197.00 L 338.00 196.00 L 338.00 193.00 L 339.00 192.00 L 339.00 182.00 L 338.00 181.00 L 338.00 178.00 L 337.00 177.00 L 337.00 176.00 L 336.00 175.00 L 336.00 174.00 L 335.00 173.00 L 335.00 172.00 L 333.00 170.00 L 333.00 169.00 L 310.00 146.00 L 310.00 145.00 L 277.00 112.00 L 277.00 111.00 L 246.00 80.00 L 246.00 79.00 L 213.00 46.00 L 213.00 45.00 L 182.00 14.00 L 182.00 13.00 L 179.00 10.00 Z"
          />
          <path
            className="logo-fill"
            d="M 176.00 10.00 L 161.00 25.00 L 160.00 25.00 L 160.00 26.00 L 159.00 27.00 L 158.00 27.00 L 61.00 124.00 L 60.00 124.00 L 16.00 168.00 L 16.00 169.00 L 14.00 171.00 L 14.00 172.00 L 13.00 173.00 L 13.00 174.00 L 12.00 175.00 L 12.00 176.00 L 11.00 177.00 L 11.00 180.00 L 10.00 181.00 L 10.00 191.00 L 11.00 192.00 L 11.00 196.00 L 12.00 197.00 L 12.00 199.00 L 13.00 200.00 L 13.00 201.00 L 14.00 202.00 L 14.00 204.00 L 16.00 206.00 L 16.00 207.00 L 17.00 208.00 L 17.00 209.00 L 19.00 211.00 L 19.00 212.00 L 30.00 223.00 L 31.00 223.00 L 33.00 225.00 L 34.00 225.00 L 36.00 227.00 L 37.00 227.00 L 38.00 228.00 L 39.00 228.00 L 40.00 229.00 L 42.00 229.00 L 43.00 230.00 L 45.00 230.00 L 46.00 231.00 L 50.00 231.00 L 51.00 232.00 L 59.00 232.00 L 60.00 231.00 L 64.00 231.00 L 65.00 230.00 L 67.00 230.00 L 68.00 229.00 L 69.00 229.00 L 70.00 228.00 L 71.00 228.00 L 73.00 226.00 L 74.00 226.00 L 78.00 222.00 L 79.00 222.00 L 81.00 220.00 L 81.00 219.00 L 121.00 179.00 L 121.00 178.00 L 161.00 138.00 L 161.00 137.00 L 177.00 121.00 L 187.00 131.00 L 187.00 132.00 L 201.00 146.00 L 201.00 147.00 L 214.00 160.00 L 214.00 161.00 L 227.00 174.00 L 227.00 175.00 L 240.00 188.00 L 240.00 189.00 L 254.00 203.00 L 254.00 204.00 L 267.00 217.00 L 267.00 218.00 L 277.00 228.00 L 278.00 228.00 L 280.00 230.00 L 281.00 230.00 L 282.00 231.00 L 284.00 231.00 L 285.00 232.00 L 288.00 232.00 L 289.00 233.00 L 297.00 233.00 L 298.00 232.00 L 302.00 232.00 L 303.00 231.00 L 305.00 231.00 L 306.00 230.00 L 308.00 230.00 L 309.00 229.00 L 310.00 229.00 L 311.00 228.00 L 312.00 228.00 L 314.00 226.00 L 315.00 226.00 L 317.00 224.00 L 318.00 224.00 L 322.00 220.00 L 323.00 220.00 L 326.00 217.00 L 326.00 216.00 L 330.00 212.00 L 330.00 211.00 L 332.00 209.00 L 332.00 208.00 L 334.00 206.00 L 334.00 205.00 L 335.00 204.00 L 335.00 203.00 L 336.00 202.00 L 336.00 200.00 L 337.00 199.00 L 337.00 197.00 L 338.00 196.00 L 338.00 193.00 L 339.00 192.00 L 339.00 182.00 L 338.00 181.00 L 338.00 178.00 L 337.00 177.00 L 337.00 176.00 L 336.00 175.00 L 336.00 174.00 L 335.00 173.00 L 335.00 172.00 L 333.00 170.00 L 333.00 169.00 L 310.00 146.00 L 310.00 145.00 L 277.00 112.00 L 277.00 111.00 L 246.00 80.00 L 246.00 79.00 L 213.00 46.00 L 213.00 45.00 L 182.00 14.00 L 182.00 13.00 L 179.00 10.00 Z"
          />
          <path
            className="logo-stroke"
            ref={strokeRef}
            d="M 176.00 10.00 L 161.00 25.00 L 160.00 25.00 L 160.00 26.00 L 159.00 27.00 L 158.00 27.00 L 61.00 124.00 L 60.00 124.00 L 16.00 168.00 L 16.00 169.00 L 14.00 171.00 L 14.00 172.00 L 13.00 173.00 L 13.00 174.00 L 12.00 175.00 L 12.00 176.00 L 11.00 177.00 L 11.00 180.00 L 10.00 181.00 L 10.00 191.00 L 11.00 192.00 L 11.00 196.00 L 12.00 197.00 L 12.00 199.00 L 13.00 200.00 L 13.00 201.00 L 14.00 202.00 L 14.00 204.00 L 16.00 206.00 L 16.00 207.00 L 17.00 208.00 L 17.00 209.00 L 19.00 211.00 L 19.00 212.00 L 30.00 223.00 L 31.00 223.00 L 33.00 225.00 L 34.00 225.00 L 36.00 227.00 L 37.00 227.00 L 38.00 228.00 L 39.00 228.00 L 40.00 229.00 L 42.00 229.00 L 43.00 230.00 L 45.00 230.00 L 46.00 231.00 L 50.00 231.00 L 51.00 232.00 L 59.00 232.00 L 60.00 231.00 L 64.00 231.00 L 65.00 230.00 L 67.00 230.00 L 68.00 229.00 L 69.00 229.00 L 70.00 228.00 L 71.00 228.00 L 73.00 226.00 L 74.00 226.00 L 78.00 222.00 L 79.00 222.00 L 81.00 220.00 L 81.00 219.00 L 121.00 179.00 L 121.00 178.00 L 161.00 138.00 L 161.00 137.00 L 177.00 121.00 L 187.00 131.00 L 187.00 132.00 L 201.00 146.00 L 201.00 147.00 L 214.00 160.00 L 214.00 161.00 L 227.00 174.00 L 227.00 175.00 L 240.00 188.00 L 240.00 189.00 L 254.00 203.00 L 254.00 204.00 L 267.00 217.00 L 267.00 218.00 L 277.00 228.00 L 278.00 228.00 L 280.00 230.00 L 281.00 230.00 L 282.00 231.00 L 284.00 231.00 L 285.00 232.00 L 288.00 232.00 L 289.00 233.00 L 297.00 233.00 L 298.00 232.00 L 302.00 232.00 L 303.00 231.00 L 305.00 231.00 L 306.00 230.00 L 308.00 230.00 L 309.00 229.00 L 310.00 229.00 L 311.00 228.00 L 312.00 228.00 L 314.00 226.00 L 315.00 226.00 L 317.00 224.00 L 318.00 224.00 L 322.00 220.00 L 323.00 220.00 L 326.00 217.00 L 326.00 216.00 L 330.00 212.00 L 330.00 211.00 L 332.00 209.00 L 332.00 208.00 L 334.00 206.00 L 334.00 205.00 L 335.00 204.00 L 335.00 203.00 L 336.00 202.00 L 336.00 200.00 L 337.00 199.00 L 337.00 197.00 L 338.00 196.00 L 338.00 193.00 L 339.00 192.00 L 339.00 182.00 L 338.00 181.00 L 338.00 178.00 L 337.00 177.00 L 337.00 176.00 L 336.00 175.00 L 336.00 174.00 L 335.00 173.00 L 335.00 172.00 L 333.00 170.00 L 333.00 169.00 L 310.00 146.00 L 310.00 145.00 L 277.00 112.00 L 277.00 111.00 L 246.00 80.00 L 246.00 79.00 L 213.00 46.00 L 213.00 45.00 L 182.00 14.00 L 182.00 13.00 L 179.00 10.00 Z"
          />
        </svg>
      </div>
      <div className="loader-text">
        <h2 className="loader-title">Real Gold</h2>
        <p className="loader-subtitle">Properties</p>
      </div>
    </div>
  );
}
